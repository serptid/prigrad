"use client";

import { motion } from "framer-motion";
import { Button } from "@nextui-org/react";
import "@/app/globals.css";
import SPWMini from 'spwmini/client';
import { useEffect, useRef, useState } from "react";

type GameButton = {
  id: string;
  position: { x: number; y: number };
  scale: number;
  isReal: boolean;
};

export default function Home() {
  const [spm, setSpm] = useState<SPWMini | null>(null);
  const [buttons, setButtons] = useState<GameButton[]>([
    { id: "root", position: { x: 0, y: 0 }, scale: 1, isReal: false },
  ]);
  const buttonRefs = useRef<Record<string, HTMLDivElement | null>>({});

  useEffect(() => {
    const spmInstance = new SPWMini('8346d39a-bc0e-48b8-9f4b-85c37a32e55a');
    setSpm(spmInstance);
  }, []);

  const handleMouseMove = (e: React.MouseEvent) => {
    const updated = buttons.map((btn) => {
      const ref = buttonRefs.current[btn.id];
      if (!ref) return btn;

      const rect = ref.getBoundingClientRect();
      const dx = e.clientX - (rect.left + rect.width / 2);
      const dy = e.clientY - (rect.top + rect.height / 2);
      const distance = Math.sqrt(dx * dx + dy * dy);

      if (distance < 250) {
        const angle = Math.atan2(dy, dx);
        const strength = Math.max(150 - distance, 30);
        const offsetX = Math.cos(angle) * -strength;
        const offsetY = Math.sin(angle) * -strength;

        const newX = Math.max(Math.min(btn.position.x + offsetX, window.innerWidth / 2 - 100), -window.innerWidth / 2 + 100);
        const newY = Math.max(Math.min(btn.position.y + offsetY, window.innerHeight / 2 - 100), -window.innerHeight / 2 + 100);
        const newScale = Math.max(0.1, distance / 300);

        return { ...btn, position: { x: newX, y: newY }, scale: newScale };
      } else {
        return { ...btn, scale: 1 };
      }
    });

    setButtons(updated);
  };

  const handleClick = (id: string, isReal: boolean) => {
    if (isReal) {
      spm?.openURL('https://discord.gg/R8D53fZFfD');
      window.open('https://discord.gg/R8D53fZFfD', '_blank', 'noopener,noreferrer');
      return;
    }

    const clickedButton = buttons.find((b) => b.id === id);
    if (!clickedButton) return;

    const children =
      id === "root"
        ? [
            {
              id: `${id}-1`,
              position: { x: clickedButton.position.x + 100, y: clickedButton.position.y + 100 },
              scale: 1,
              isReal: false,
            },
          ]
        : Array.from({ length: 3 }).map((_, i) => ({
            id: `${id}-child-${i}`,
            position: {
              x: clickedButton.position.x + (i - 1) * 120,
              y: clickedButton.position.y + 120,
            },
            scale: 1,
            isReal: i === Math.floor(Math.random() * 3),
          }));

    setButtons((prev) => [...prev, ...children]);
  };

  return (
    <main
      onMouseMove={handleMouseMove}
      className="relative min-h-screen bg-gradient-to-b from-green-950 to-green-800 overflow-hidden flex flex-col items-center justify-center py-6 px-6 font-sans"
    >
      <div className="absolute inset-0 bg-[url('/leaf-texture.png')] bg-cover opacity-20 animate-pulse"></div>

      <motion.h1
        initial={{ opacity: 0, y: -40 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.8 }}
        className="text-7xl font-extrabold mb-4 text-center text-green-100 drop-shadow-[0_0_12px_rgba(34,197,94,0.8)] tracking-wide"
      >
        –ü—Ä—ã–≥—Ä–∞–¥
      </motion.h1>

      <motion.p
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.8, delay: 0.3 }}
        className="text-[1.35rem] max-w-2xl text-center mb-8 text-green-200 leading-relaxed"
      >
        –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ü—Ä—ã–≥—Ä–∞–¥ ‚Äî –∑–µ–ª—ë–Ω—ã–π –∏ —Ç—ë–ø–ª—ã–π –≥–æ—Ä–æ–¥ Minecraft, –≥–¥–µ –¥–µ—Ä–µ–≤—å—è –æ–±–Ω–∏–º–∞—é—Ç –∑–¥–∞–Ω–∏—è, –∞ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –∑–∞ –∫–∞–∂–¥—ã–º —Ö–æ–ª–º–æ–º.
      </motion.p>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
        <FeatureCard
          title="üéÆ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤"
          description="–ì–æ—Ä–æ–¥ –æ—á–µ–Ω—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω –∫ –º–µ–ª–æ—á–∞–º –∏ —Å–∫—É—Ä–ø—É–ª—ë–∑–Ω–æ –∏—Ö –ø—Ä–æ—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç. –í –ª—é–±–æ–π –¥–µ–∫–æ—Ä–∞—Ü–∏–µ–π –µ—Å—Ç—å –∫–∞–∫–æ–µ-—Ç–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ, –≤–µ–∑–¥–µ –µ—Å—Ç—å –∫–∞–∫–∏–µ-—Ç–æ –º–∏–Ω–∏-–∏–≥—Ä—ã, –¥–∞–Ω–∂–∏ –∏–ª–∏ –∫–≤–µ—Å—Ç—ã –æ—Ç –ù–ü–° –∏–ª–∏ –ë–û–°–°–´!"
        />
        <FeatureCard
          title="üèÉ –ü–∞—Ä–∫—É—Ä"
          description="–ù–∞ –ª—é–±—É—é –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –≤ –≥–æ—Ä–æ–¥–µ –º–æ–∂–Ω–æ –∑–∞–ø–∞—Ä–∫—É—Ä–∏—Ç—å. –ö—É–¥–∞ —É–≥–æ–¥–Ω–æ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ø–∞—Å—Ç—å –∏ —ç—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –∏–Ω–æ–≥–¥–∞ —Å –ø–æ–º–æ—â—å—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è."
        />
        <FeatureCard
          title="üéâ –ò–≤–µ–Ω—Ç—ã"
          description="–í –≥–æ—Ä–æ–¥–µ –∫—É—á–∞ –∑–∞–≥–æ—Ç–æ–≤–æ–∫ –¥–ª—è –∏–≤–µ–Ω—Ç–æ–≤, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö, –∫–∞–∫ –∏–∑ –∫–∏—Ä–ø–∏—á–∏–∫–æ–≤ –ª–µ–≥–æ, —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∏–≤–µ–Ω—Ç—ã. –ë–ª–∞–≥–æ–¥–∞—Ä—è –≤—Å–µ–º—É —ç—Ç–æ–º—É, –∏–≤–µ–Ω—Ç—ã –≤ –ü—Ä—ã–≥—Ä–∞–¥–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –º–∏–Ω–∏–º—É–º —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é, –Ω–µ —Ç–µ—Ä—è—è –ø—Ä–∏ —ç—Ç–æ–º –≤ –∫–∞—á–µ—Å—Ç–≤–µ."
        />
      </div>

      {buttons.map((btn) => (
        <motion.div
          key={btn.id}
          ref={(el) => { buttonRefs.current[btn.id] = el; }}
          animate={{ x: btn.position.x, y: btn.position.y, scale: btn.scale }}
          transition={{ type: "spring", stiffness: 300, damping: 25 }}
          className="absolute"
        >
          <Button
            color="success"
            radius="full"
            size="lg"
            className="bg-green-700 hover:bg-green-800 text-md font-bold py-3.5 px-7 shadow-xl"
            onClick={() => handleClick(btn.id, btn.isReal)}
          >
            {btn.isReal ? "–ù–∞—Å—Ç–æ—è—â–∏–π –ø–æ—Ä—Ç–∞–ª" : "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ü—Ä—ã–≥—Ä–∞–¥—É"}
          </Button>
        </motion.div>
      ))}
    </main>
  );
}

function FeatureCard({ title, description }: { title: string; description: string }) {
  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      whileHover={{ scale: 1.1 }}
      transition={{ duration: 0.6, type: "spring", stiffness: 300 }}
      className="bg-green-800 rounded-2xl shadow-2xl p-7 border-4 border-green-600 text-center cursor-pointer"
    >
      <h2 className="text-[1.65rem] font-semibold mb-4 text-green-100 tracking-wide">{title}</h2>
      <p className="text-green-200 text-base leading-relaxed">{description}</p>
    </motion.div>
  );
}
